<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - E-Shop</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .admin-tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .admin-tab {
            flex: 1;
            padding: 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .admin-tab.active {
            background: #667eea;
            color: white;
        }
        .admin-content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .admin-section {
            display: none;
        }
        .admin-section.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .admin-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2><i class="fas fa-shopping-cart"></i> E-Shop - Admin</h2>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Retour au site</a>
                <div class="nav-user" id="nav-user">
                    <span class="user-name" id="user-name">Administrateur</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="admin-container">
            <h1><i class="fas fa-cog"></i> Panneau d'Administration</h1>
            <p style="color: #e74c3c; font-weight: bold;">⚠️ Attention: Cette page est accessible publiquement à des fins de démonstration</p>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-bar"></i> Dashboard
                </button>
                <button class="admin-tab" onclick="showSection('users')">
                    <i class="fas fa-users"></i> Utilisateurs
                </button>
                <button class="admin-tab" onclick="showSection('products')">
                    <i class="fas fa-box"></i> Produits
                </button>
                <button class="admin-tab" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i> Commandes
                </button>
            </div>

            <div class="admin-content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="admin-section active">
                    <h2>Statistiques Générales</h2>
                    <div class="stats-grid" id="stats-grid">
                        <!-- Les statistiques seront chargées dynamiquement -->
                    </div>
                    
                    <h3>Activité Récente</h3>
                    <div id="recent-activity">
                        <!-- L'activité récente sera chargée dynamiquement -->
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users" class="admin-section">
                    <h2>Gestion des Utilisateurs</h2>
                    
                    <div class="admin-form">
                        <div class="form-container">
                            <h3>Ajouter un Utilisateur</h3>
                            <form id="add-user-form">
                                <div class="form-group">
                                    <label>Nom</label>
                                    <input type="text" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label>Mot de passe</label>
                                    <input type="password" name="password" required>
                                </div>
                                <div class="form-group">
                                    <label>Rôle</label>
                                    <select name="role">
                                        <option value="user">Utilisateur</option>
                                        <option value="admin">Administrateur</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Ajouter</button>
                            </form>
                        </div>
                    </div>
                    
                    <table class="data-table" id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Mot de passe</th>
                                <th>Rôle</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <!-- Les utilisateurs seront chargés dynamiquement -->
                        </tbody>
                    </table>
                </div>

                <!-- Products Section -->
                <div id="products" class="admin-section">
                    <h2>Gestion des Produits</h2>
                    
                    <div class="admin-form">
                        <div class="form-container">
                            <h3>Ajouter un Produit</h3>
                            <form id="add-product-form">
                                <div class="form-group">
                                    <label>Nom</label>
                                    <input type="text" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea name="description" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Prix</label>
                                    <input type="number" name="price" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Stock</label>
                                    <input type="number" name="stock_quantity" required>
                                </div>
                                <div class="form-group">
                                    <label>Catégorie</label>
                                    <select name="category_id" id="category-select">
                                        <!-- Les catégories seront chargées dynamiquement -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>SKU</label>
                                    <input type="text" name="sku" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Ajouter</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="orders" class="admin-section">
                    <h2>Gestion des Commandes</h2>
                    <table class="data-table" id="orders-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Utilisateur</th>
                                <th>Total</th>
                                <th>Statut</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <!-- Les commandes seront chargées dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script>
        // JavaScript pour l'administration
        let currentSection = 'dashboard';

        document.addEventListener('DOMContentLoaded', async function() {
            await loadDashboard();
            await loadCategories();
        });

        function showSection(section) {
            // Masquer toutes les sections
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            
            // Afficher la section sélectionnée
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            currentSection = section;
            
            // Charger les données de la section
            switch(section) {
                case 'users':
                    loadUsers();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'dashboard':
                    loadDashboard();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                const data = await api.getDashboard();
                const statsGrid = document.getElementById('stats-grid');
                
                const stats = [
                    { title: 'Utilisateurs', value: data.query_0[0]?.total_users || 0, icon: 'fa-users' },
                    { title: 'Produits', value: data.query_1[0]?.total_products || 0, icon: 'fa-box' },
                    { title: 'Commandes', value: data.query_2[0]?.total_orders || 0, icon: 'fa-shopping-cart' },
                    { title: 'Revenus', value: Utils.formatPrice(data.query_3[0]?.total_revenue || 0), icon: 'fa-euro-sign' }
                ];
                
                statsGrid.innerHTML = stats.map(stat => `
                    <div class="stat-card">
                        <i class="fas ${stat.icon}" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <div class="stat-number">${stat.value}</div>
                        <div>${stat.title}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erreur dashboard:', error);
            }
        }

        async function loadUsers() {
            try {
                const users = await api.getAdminUsers();
                const tbody = document.getElementById('users-tbody');
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td style="color: #e74c3c; font-family: monospace;">${user.password}</td>
                        <td>${user.role}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="changeUserRole(${user.id}, '${user.role === 'admin' ? 'user' : 'admin'}')">
                                ${user.role === 'admin' ? 'Dégrader' : 'Promouvoir'}
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Erreur users:', error);
            }
        }

        async function loadOrders() {
            try {
                const orders = await api.getOrders();
                const tbody = document.getElementById('orders-tbody');
                
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.user_name} (${order.user_email})</td>
                        <td>${Utils.formatPrice(order.total_amount)}</td>
                        <td>${order.status}</td>
                        <td>${Utils.formatDate(order.created_at)}</td>
                        <td>
                            <select onchange="updateOrderStatus(${order.id}, this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>En attente</option>
                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmée</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Expédiée</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Livrée</option>
                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annulée</option>
                            </select>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Erreur orders:', error);
            }
        }

        async function loadCategories() {
            try {
                const categories = await api.getCategories();
                const select = document.getElementById('category-select');
                
                select.innerHTML = categories.map(cat => 
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');
                
            } catch (error) {
                console.error('Erreur categories:', error);
            }
        }

        // Gestionnaires de formulaires
        document.getElementById('add-user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);
            
            try {
                await api.addUser(userData);
                Utils.showAlert('Utilisateur ajouté avec succès', 'success');
                e.target.reset();
                if (currentSection === 'users') loadUsers();
            } catch (error) {
                Utils.showAlert('Erreur lors de l\'ajout', 'error');
            }
        });

        document.getElementById('add-product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData);
            
            try {
                await api.addProduct(productData);
                Utils.showAlert('Produit ajouté avec succès', 'success');
                e.target.reset();
            } catch (error) {
                Utils.showAlert('Erreur lors de l\'ajout', 'error');
            }
        });

        async function changeUserRole(userId, newRole) {
            try {
                await api.updateUserRole(userId, newRole);
                Utils.showAlert('Rôle modifié avec succès', 'success');
                loadUsers();
            } catch (error) {
                Utils.showAlert('Erreur lors de la modification', 'error');
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                // Simulation de mise à jour du statut
                Utils.showAlert('Statut de commande mis à jour', 'success');
            } catch (error) {
                Utils.showAlert('Erreur lors de la mise à jour', 'error');
            }
        }
    </script>
</body>
</html>